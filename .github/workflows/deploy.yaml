name: Deploy to AWS EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout the repository
      - name: Checkout code
        uses: actions/checkout@v3

      # Step 2: Set up Node.js environment
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      # Step 3: Install dependencies
      - name: Install dependencies
        run: npm ci

      # Step 4: Run tests
      - name: Run tests
        run: npm test

      # Step 5: Build the project
      - name: Build the project
        run: npm run build

      # Step 6: Debug Build Output
      - name: Debug Build Output
        run: |
          echo "Inspecting build output..."
          ls -R dist
          if [ ! -f dist/src/main.js ]; then
            echo "Error: main.js not found in dist directory. Check build configuration."
            exit 1
          fi

      # Step 7: Deploy to AWS EC2
      - name: Deploy to AWS EC2
        env:
          AWS_PRIVATE_KEY: ${{ secrets.AWS_PRIVATE_KEY }}
          AWS_HOST: ${{ secrets.AWS_HOST }}
          AWS_USERNAME: ec2-user
        run: |
          echo "$AWS_PRIVATE_KEY" > private_key.pem
          chmod 600 private_key.pem

          echo "Deploying to EC2 instance..."
          scp -i private_key.pem -r dist package.json package-lock.json $AWS_USERNAME@$AWS_HOST:/home/ec2-user/app

          ssh -i private_key.pem $AWS_USERNAME@$AWS_HOST << 'EOF'
            cd /home/ec2-user/app
            npm ci --omit=dev
            pm2 restart all || pm2 start "npm run start:prod" --name "my-nestjs-app"
            exit
          EOF

          echo "Deployment completed successfully."

      # Step 8: Clean up private key
      - name: Clean up private key
        run: rm -f private_key.pem
